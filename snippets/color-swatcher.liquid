{%- liquid
  assign seen_colors = ''
  assign color_count = 0
-%}

<div class="colors flex gap-4">
  {%- for variant in product.variants limit: 100 -%}
    {%- assign current_color = variant.options[option_index] -%}
    
    {%- if current_color != blank -%}
      {%- if seen_colors contains current_color -%}
        {%- continue -%}
      {%- endif -%}
      
      {%- if color_count >= 3 -%}
        {%- break -%}
      {%- endif -%}
      
      {%- assign color_count = color_count | plus: 1 -%}
      {%- assign seen_colors = seen_colors | append: current_color | append: ',' -%}
      
      {%- assign is_available = false -%}
      {%- for v in product.variants -%}
        {%- if v.options[option_index] == current_color and v.available -%}
          {%- assign is_available = true -%}
          {%- break -%}
        {%- endif -%}
      {%- endfor -%}

      {%- assign color_image = nil -%}
      {%- for v in product.variants -%}
        {%- if v.options[option_index] == current_color and v.image -%}
          {%- assign color_image = v.image.src -%}
          {%- break -%}
        {%- endif -%}
      {%- endfor -%}
      
      {%- if color_image == nil -%}
        {%- assign color_image = product.featured_image.src -%}
      {%- endif -%}

      <button
        type="button"
        class="color-btn relative border-2 border-transparent [&.active]:outline [&.active]:outline-2 [&.active]:outline-black dark:[&.active]:outline-white focus:outline-2! dark:focus:outline-white! [&.unavailable]:opacity-60 [&.unavailable]:cursor-not-allowed {% if color_count == 1 %} active {% endif %}{% unless is_available %} unavailable{% endunless %}"
        data-color="{{ current_color | escape }}"
        aria-label="{{-'products.card.select_color' | t -}} {{ current_color | escape }}">

        <img
          src="{{ color_image | image_url: width: 100 }}"
          alt="{{ current_color | escape }}"
          width="88"
          height="88"
          loading="lazy"
          class="object-cover cursor-pointer border border-transparent">
        
        <span class="unavailable-line absolute top-1/2 left-0 w-full h-0.5 bg-red-500 -translate-y-1/2 rotate-135 pointer-events-none
          {% unless is_available %} block {% else %} hidden {% endunless %}
        "></span>
      </button>
    {%- endif -%}
  {%- endfor -%}
</div>